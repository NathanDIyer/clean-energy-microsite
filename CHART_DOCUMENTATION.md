# Chart Documentation

This document describes how each chart in the microsite is generated, what data sources are used, and how to modify them.

## Overview

All charts are generated by `generate_charts.py` which:
1. Loads zone data from the main project's `data_loader.py`
2. Runs optimizations using `experimental/optimizer_v4.py` (with `hybrid_mode=True`)
3. Simulates systems using `simulation.py`
4. Calculates costs using `lcoe_calculator.py`
5. Exports Plotly JSON to `microsite/data/*.json`

The frontend (`js/charts.js`) loads these JSON files and renders them with Plotly.js.

---

## Data Sources

### Zone Data
- **Source**: `data_loader.py` → `load_all_zone_data()`
- **Contents**: Hourly profiles for 13 US zones (8760 hours)
  - `solar`: Normalized solar capacity factor (0-1)
  - `wind`: Normalized wind capacity factor (0-1)
  - `load`: Load in MW (scaled to ~100-170 MW peak)
- **Default Zone**: California (used for most charts)

### Cost Settings
- **Source**: `cost_settings_modal.py` → `DEFAULT_COSTS`
- **Key Parameters**:
  ```python
  solar: 1000 $/kW
  wind: 1200 $/kW
  storage: 300 $/kWh (4-hour duration)
  clean_firm: 5000 $/kW
  gas_capex: 1200 $/kW
  gas_price: 4 $/MMBtu
  gas_heat_rate: 7.5 MMBtu/MWh
  discount_rate: 7%
  ```

### Optimizer
- **Source**: `experimental/optimizer_v4.py` → `run_min_lcoe_v4_adaptive()`
- **Method**: Adaptive grid search with local refinement
- **Key Setting**: `hybrid_mode=True` for smoother battery dispatch

---

## Chart Details

### 1. Mismatch Chart (`mismatch.json`)
**Function**: `generate_mismatch_chart()`

**What it shows**: Solar production vs electricity demand by hour of day

**How it works**:
- Averages solar and load profiles across all 8760 hours, grouped by hour of day (0-23)
- Normalizes both to 0-100% scale
- Shows the fundamental timing mismatch (solar peaks at noon, demand peaks at 6pm)

**Key insight**: Evening gap that needs to be filled by storage, wind, or firm power

---

### 2. LCOE Curve (`lcoe_curve.json`)
**Function**: `generate_lcoe_curve()`

**What it shows**: System LCOE vs clean energy target (50-99%)

**How it works**:
- Runs V4 optimizer at each target: `[50, 60, 70, 80, 85, 90, 92, 94, 95, 96, 97, 98, 99]`
- Plots resulting LCOE with gas baseline reference line ($65/MWh)
- Shaded zones indicate optimization phases (Easy → Storage Era → Reliability)

**Key insight**: Cost increases gradually until ~90%, then accelerates

---

### 3. Resource Mix (`resource_mix.json`)
**Function**: `generate_resource_mix()`

**What it shows**: Annual energy (GWh) by resource type vs clean target

**How it works**:
- Runs optimizer at each target
- **Simulates** the resulting system to get actual energy delivered:
  ```python
  simulate_system(solar_capacity, wind_capacity, storage_capacity, clean_firm_capacity, ...)
  ```
- Extracts:
  - `solar_out`: Solar energy delivered to load
  - `wind_out`: Wind energy delivered to load
  - `storage_out`: Only **discharge** (positive values) counted as shifted energy
  - `clean_firm_gen`: Clean firm energy
- Calculates CF share: `cf_gwh / total_clean * 100`
- Annotates when clean firm becomes >50% of clean energy

**Key insight**: Clean firm becomes majority at ~97% target

**Note**: Shows ENERGY (GWh), not capacity (MW). Storage shows only discharged energy.

---

### 4. Solar Paradox (`solar_paradox.json`)
**Function**: `generate_solar_paradox()`

**What it shows**: Solar-only has a ceiling around 50% clean energy

**How it works**:
- Sweeps solar capacity from 0 to 1000 MW in 50 MW steps
- **No wind, no storage, no clean firm** - pure solar only
- Simulates each configuration and calculates:
  - Clean match %: `renewable_delivered / annual_load * 100`
  - System LCOE
- Shows the ceiling where more solar doesn't increase match (only curtailment)

**Key insight**: Solar alone maxes out at ~50% - you physically can't push higher without storage or other resources

---

### 5. ELCC/Effectiveness (`elcc.json`)
**Function**: `generate_elcc_chart()`

**What it shows**: Diminishing returns as you add each resource type

**How it works**:
- Base system: 200 MW Solar, 100 MW Wind, 200 MWh Storage, 20 MW Clean Firm
- For each resource, sweeps from 0 to max while holding others at base:
  - Solar: 0→800 MW
  - Wind: 0→400 MW
  - Storage: 0→1600 MWh
  - Clean Firm: 0→100 MW
- Plots clean match % vs capacity added

**Key insight**: Clean firm has nearly linear returns; solar/wind show steep diminishing returns

---

### 6. Leap Chart (`leap.json`)
**Function**: `generate_leap_chart()`

**What it shows**: Weekly dispatch comparison at 70% vs 95% targets

**How it works**:
- Optimizes systems for 70% and 95% targets
- Simulates both and extracts one week of hourly dispatch (hours 720-888, winter week)
- Stacks generation: Clean Firm (bottom) → Storage → Wind → Solar → Gas (top)
- Load shown as dotted line

**Key insight**: At 70% gas fills gaps; at 95% clean firm takes over

**Stack order**: Clean firm at bottom (most reliable), gas at top (least desirable)

---

### 7. Regional Comparison (`regional.json`)
**Function**: `generate_regional_comparison()`

**What it shows**: How optimal mix varies by region at 95% target

**How it works**:
- Runs optimizer for California, Texas, Florida at 95% target
- Simulates each to get energy breakdown (GWh)
- Creates stacked bar chart with LCOE annotations

**Key findings**:
- Texas: Strong wind → lowest LCOE ($83)
- California: Balanced mix → moderate LCOE ($100)
- Florida: No wind → heavy clean firm reliance → highest LCOE ($109)

---

### 8. No Clean Firm (`no_cleanfirm.json`)
**Function**: `generate_no_cleanfirm_chart()`

**What it shows**: Cost explosion without clean firm power

**How it works**:
- Runs optimizer with `use_clean_firm=True` and `use_clean_firm=False`
- Compares LCOE at each target

**Key insight**: Without clean firm, 99% target costs $154/MWh vs $110/MWh (+40%)

---

### 9. No Wind / Resource Availability (`no_wind.json`)
**Function**: `generate_no_wind_chart()`

**What it shows**: Three scenarios comparing resource availability

**How it works**:
- **Solar + Storage only**: `use_wind=False, use_clean_firm=False`
- **Solar + Storage + Clean Firm**: `use_wind=False, use_clean_firm=True`
- **Full Mix**: All resources enabled

**Key insight**: Solar+Storage alone costs $178/MWh at 95%; adding clean firm drops to $105; adding wind drops to $100

---

### 10. Greedy vs Optimal (`greedy.json`)
**Function**: `generate_greedy_comparison()`

**What it shows**: Cost penalty of naive "greedy" optimization

**How it works**:
- **Optimal**: V4 optimizer (global optimization)
- **Greedy**: Custom `run_greedy_optimization()` function:
  - Starts with 0 of everything
  - Iteratively adds 10 MW of whichever resource gives best $/% improvement
  - Stops when target reached
  - Uses 300 max iterations

**Key insight**: Greedy works at low targets but costs ~10% more at 99%

---

### 11. Cost Sensitivity (`cost_sensitivity.json`)
**Function**: `generate_cost_sensitivity()`

**What it shows**: How LCOE changes under different cost scenarios

**Scenarios**:
- Baseline: Default costs
- Cheap Storage: `storage: 150 $/kWh` (50% reduction)
- Cheap Clean Firm: `clean_firm: 2500 $/kW` (50% reduction)
- Expensive Gas: `gas_price: 8 $/MMBtu` (2x increase)

---

### 12. Gas Capacity Requirements (`gas_capacity.json`)
**Function**: `generate_gas_capacity_sweep()`

**What it shows**: How much backup gas capacity is needed at each target

**How it works**:
- Runs optimizer at targets 50-98% (every 2%)
- Simulates and extracts `max(gas_gen)` as required gas capacity
- Compares to peak load

**Key insight**: Even at 95%, you need ~50% of peak load as gas backup

---

### 13. Resource Interactions (`resource_interactions.json`)
**Function**: `generate_resource_interactions()`

**What it shows**: Synergy between resources (solar+storage vs solar+wind)

**How it works**:
- Sweeps solar 0→600 MW under 4 scenarios:
  1. Solar only
  2. Solar + 100 MW wind
  3. Solar + 400 MWh storage
  4. Solar + wind + storage
- Calculates clean match % for each

**Key insight**: Storage boosts solar more at high solar levels (shifts excess); wind provides additive generation

---

### 14. Gas LCOE Impact (`gas_lcoe_impact.json`)
**Function**: `generate_gas_lcoe_impact()`

**What it shows**: Gas capacity vs its contribution to system LCOE

**How it works**:
- Runs optimizer and simulation at 70, 80, 90, 95, 99%
- Calculates gas contribution to LCOE:
  ```python
  gas_annual_cost = gas_cap * gas_capex * 0.08  # CRF
  gas_fuel_cost = gas_mwh * gas_price * heat_rate / 1000
  gas_lcoe = (gas_annual_cost + gas_fuel_cost) / annual_load * 1000
  ```

**Key insight**: At 99%, gas provides reliability but only adds $6/MWh to total LCOE

---

### 15. Cost Structure (`cost_structure.json`)
**Function**: `generate_cost_structure()`

**What it shows**: Capex vs Opex breakdown by technology

**How it works**:
- Calculates LCOE components for each technology:
  - Capex: `(capex_kw * CRF * 1000) / annual_gen`
  - O&M: Fixed + variable
  - Fuel: Only for gas and some clean firm
- Uses assumed capacity factors (Solar: 25%, Wind: 35%, etc.)

**Key insight**: Solar is 86% capex; Gas is 41% capex (59% fuel)

---

### 16. Financing Impact (`financing.json`)
**Function**: `generate_financing_impact()`

**What it shows**: Cost of capital vs ITC impact

**Scenarios**:
- Baseline: 7% discount rate, no ITC
- With 30% ITC: 7% discount rate
- Low cost of capital: 4% discount rate, no ITC
- Both: 4% + 30% ITC

**Key insight**: Lower discount rate saves as much as ITC for capital-intensive clean energy

---

### 17. Gas Price Crossover (`gas_crossover.json`)
**Function**: `generate_gas_crossover()`

**What it shows**: At what gas price clean energy beats gas-only

**How it works**:
- Sweeps gas prices: $2-15/MMBtu
- Calculates LCOE for gas-only and clean systems at 70%, 90%, 95%
- Gas-only LCOE: `gas_price * heat_rate + 35` (fuel + fixed costs)

**Key insight**: At $8+/MMBtu gas, 90% clean becomes cost-competitive

---

### 18. Clean Firm Technology (`cleanfirm_tech.json`)
**Function**: `generate_cleanfirm_comparison()`

**What it shows**: How different clean firm technologies compare under different financing

**Technologies**:
- Geothermal: $5000/kW capex, $0 fuel (100% capex)
- Nuclear: $8000/kW capex, $10/MWh fuel
- Hydrogen: $1500/kW capex, $60/MWh fuel

**How it works**:
- Calculates standalone LCOE at discount rates 3-12%
- Shows how capex-heavy technologies (geothermal) are more sensitive to financing

---

## How to Modify Charts

### Change default zone
In each function, change the `zone` parameter:
```python
def generate_lcoe_curve(zone_data, zone='Texas', cost_settings=None):
```

### Change target sweep points
Modify the `targets` list:
```python
targets = [50, 60, 70, 80, 85, 90, 92, 94, 95, 96, 97, 98, 99]
```

### Change cost assumptions
Override `cost_settings`:
```python
cost_settings = {**DEFAULT_COSTS, 'solar': 800, 'storage': 200}
```

### Add a new chart
1. Create function in `generate_charts.py`
2. Add to `charts` dict in `main()`
3. Add container ID to `CHARTS` in `js/charts.js`
4. Add `<div id="chart-name" class="chart-container"></div>` to `index.html`

---

## Regenerating Charts

```bash
cd /path/to/Multi-Heatmap\ Test
python microsite/generate_charts.py
```

Takes ~3-5 minutes due to multiple optimization runs.

---

## File Structure

```
microsite/
├── index.html              # Main page with chart containers
├── css/style.css           # Styling
├── js/charts.js            # Chart loader (maps IDs to JSON files)
├── data/                   # Generated chart JSON files
│   ├── mismatch.json
│   ├── lcoe_curve.json
│   └── ... (18 total)
├── generate_charts.py      # Chart generation script
├── CHART_DOCUMENTATION.md  # This file
└── README.md               # Quick start guide
```
