# Chart Documentation

This document describes how each chart in the microsite is generated, what data sources are used, and how to modify them.

## Overview

All charts are generated by `generate_charts.py` which:
1. Loads zone data from the main project's `data_loader.py`
2. Runs simulations using `simulation.py` (with `hybrid_mode=True` for solar+storage charts)
3. Calculates costs using `lcoe_calculator.py`
4. Exports Plotly JSON to `microsite/data/*.json`

The frontend (`js/charts.js`) loads these JSON files and renders them with Plotly.js.

---

## Data Sources

### Zone Data
- **Source**: `data_loader.py` → `load_all_zone_data()`
- **Contents**: Hourly profiles for 13 US zones (8760 hours)
  - `solar`: Normalized solar capacity factor (0-1)
  - `wind`: Normalized wind capacity factor (0-1)
  - `load`: Load in MW (scaled to ~100-170 MW peak)
- **Default Zone**: California (used for most charts)

### Cost Settings
- **Source**: `cost_settings_modal.py` → `DEFAULT_COSTS`
- **Key Parameters**:
  ```python
  solar: 1000 $/kW
  wind: 1200 $/kW
  storage: 300 $/kWh (4-hour duration)
  clean_firm: 5000 $/kW
  gas_capex: 1200 $/kW
  gas_price: 4 $/MMBtu
  gas_heat_rate: 7.5 MMBtu/MWh
  discount_rate: 7%
  ```

### Simulation
- **Source**: `simulation.py` → `simulate_system()`
- **Key Setting**: `hybrid_mode=True` for smoother battery dispatch in solar+storage charts
- **Returns**: 8760-hour arrays of generation, storage, curtailment

### Optimization
- For charts requiring optimization, grid search is used with minimum LCOE objective
- Sweeps over solar capacity and storage hours to find lowest-cost configuration at each clean energy target

---

## Chart Details by Section

---

## Part 1: The Mystery

### 1. Technology LCOE Comparison (`tech_lcoe.json`)
**Function**: `generate_tech_lcoe_comparison()`

**What it shows**: Bar chart comparing levelized cost by technology with range indicators

**How it works**:
- Calculates LCOE for Solar, Wind, Gas, Clean Firm
- Shows default costs as bars with error bars for low/high scenarios
- Range labels displayed to the right of each bar (e.g., "$28-$72")
- "Cheapest!" label above solar bar
- Hover tooltips disabled for cleaner presentation

**Assumptions dropdown**: HTML section includes collapsible table with CAPEX, capacity factor, O&M, and fuel assumptions

---

### 2. Cost Structure (`cost_structure.json`)
**Function**: `generate_cost_structure()`

**What it shows**: Capex vs Opex breakdown by technology

**How it works**:
- Stacked bar chart: Capex (bottom) + O&M + Fuel (top)
- Uses assumed capacity factors (Solar: 25%, Wind: 35%, etc.)
- "86% capex" label above solar bar (black text)
- Hover tooltips disabled

**Key insight**: Solar is 86% capex; Gas is 41% capex (59% fuel)

---

### 3. LCOE Curve (`lcoe_curve.json`)
**Function**: `generate_lcoe_curve()`

**What it shows**: System LCOE vs clean energy target (50-99%)

**How it works**:
- Runs optimizer at each target: `[50, 60, 70, 80, 85, 90, 92, 94, 95, 96, 97, 98, 99]`
- Plots resulting LCOE with gas baseline reference line ($65/MWh)
- Shaded zones indicate optimization phases (Easy → Storage Era → Reliability)

**Key insight**: Cost increases gradually until ~90%, then accelerates

---

## Part 2: The Energy Problem

### 4. Mismatch Chart (`mismatch.json`)
**Function**: `generate_mismatch_chart()`

**What it shows**: Solar production vs electricity demand by hour of day

**How it works**:
- Averages solar and load profiles across all 8760 hours, grouped by hour (0-23)
- Normalizes both to 0-100% scale
- Shows the fundamental timing mismatch

**Key insight**: Solar peaks at noon, demand peaks at 6pm

---

### 5. Solar Storage Ceiling (`solar_storage_ceiling.json`)
**Function**: `generate_solar_storage_ceiling()`

**What it shows**: How storage extends solar's clean energy ceiling

**How it works**:
- Sweeps solar capacity 0-1200 MW with different storage durations (0h, 2h, 4h, 6h, 8h)
- Uses `hybrid_mode=True` for battery dispatch
- Shows clean match % vs solar capacity for each storage level

**Key insight**: Each hour of storage raises solar's ceiling by ~5-8 percentage points

---

### 6. Wind Storage Ceiling (`wind_storage_ceiling.json`)
**Function**: `generate_wind_storage_ceiling()`

**What it shows**: Wind's clean energy ceiling with and without storage

**How it works**:
- Same methodology as solar ceiling chart
- Sweeps wind capacity with 0h, 4h, 8h storage

**Key insight**: Wind reaches ~94% ceiling without storage; storage helps less than with solar

---

### 7. Solar+Storage LCOE Sweep (`solar_storage_lcoe.json`)
**Function**: `generate_solar_storage_lcoe()`

**What it shows**: Optimized LCOE curve for solar+storage only systems with storage hour markers

**How it works**:
- Sweeps clean energy targets from 5% to 95% in 2% increments
- **At each target, runs grid search** over:
  - Solar capacity: 25-2000 MW (25 MW steps)
  - Storage hours: 0, 0.5, 1, 1.5, 2, 2.5, 3, 4, 5, 6, 7, 8, 10, 12
- Uses `hybrid_mode=True` for simulation
- Finds minimum LCOE configuration at each target
- Draws **vertical dashed lines** when optimal storage crosses 1h, 2h, 3h, etc. thresholds
- Labels show when storage hours increase

**Key insight**: Cost explodes as you approach solar's ceiling; more storage hours needed at higher targets

---

### 8. Storage Cost Sensitivity (`storage_cost_sensitivity.json`)
**Function**: `generate_storage_cost_sensitivity()`

**What it shows**: How cheaper storage bends the LCOE curve

**How it works**:
- Same grid search optimization as solar+storage LCOE
- Four lines for different storage costs: $300, $200, $100, $50/kWh
- Uses `hybrid_mode=True` for all simulations
- No storage hour markers (cleaner comparison)

**Key insight**: Even at $50/kWh storage, solar-only systems still cost more than diversified portfolios at high targets

---

### 9. Effective LCOE (`effective_lcoe.json`)
**Function**: `generate_effective_lcoe()`

**What it shows**: How curtailment increases effective cost per useful MWh

**How it works**:
- Sweeps solar capacity with no storage
- Calculates: Effective LCOE = Nominal LCOE / (1 - Curtailment%)
- Shows both nominal and effective curves

**Key insight**: At 500 MW solar with 50% curtailment, effective cost is ~$100/MWh (not $50/MWh)

---

### 10. ELCC Chart (`elcc.json`)
**Function**: `generate_elcc_chart()`

**What it shows**: Clean energy ceiling for each resource type in isolation

**How it works**:
- Sweeps each resource independently from 0 to max capacity
- Solar: 0-800 MW, Wind: 0-400 MW, Storage: 0-1600 MWh, Clean Firm: 0-100 MW
- All other resources held at 0

**Key insight**: Solar caps at ~50%, Wind at ~70%, Clean Firm has linear returns to 100%

---

## Part 3: The Capacity Problem

### 11. ELCC Solar+Storage (`elcc_solar_storage.json`)
**Function**: `generate_elcc_solar_storage()`

**What it shows**: How storage improves solar's capacity credit

**How it works**:
- Fixed solar capacity, sweeps storage duration 0-12 hours
- Measures clean match improvement

**Key insight**: Even 8 hours of storage only lifts solar's capacity credit to ~55%

---

### 12. ELCC Wind+Storage (`elcc_wind_storage.json`)
**Function**: `generate_elcc_wind_storage()`

**What it shows**: Storage provides less benefit to wind due to multi-day variability

**How it works**:
- Fixed wind capacity, sweeps storage duration
- Shows diminishing returns

---

## Part 4: The Solution

### 13. Resource Mix (`resource_mix.json`)
**Function**: `generate_resource_mix()`

**What it shows**: Annual energy (GWh) by resource type vs clean target

**How it works**:
- Runs optimizer at each target
- Simulates resulting system to get actual energy delivered
- Stacked area chart: Solar, Wind, Storage (discharge), Clean Firm
- Annotates when clean firm becomes >50% of clean energy

**Key insight**: Clean firm becomes majority at ~97% target; solar decreases after 85%

---

### 14. LCOE Breakdown (`lcoe_breakdown.json`)
**Function**: `generate_lcoe_breakdown()`

**What it shows**: How each resource contributes to total system LCOE at 95% target

**How it works**:
- Runs optimizer at 95% target
- Breaks down LCOE by: Solar, Wind, Storage, Clean Firm, Gas
- Stacked bar chart

**Key insight**: Clean firm is 38% of cost but enables 95% clean

---

### 15. Gas LCOE Impact (`gas_lcoe_impact.json`)
**Function**: `generate_gas_lcoe_impact()`

**What it shows**: Gas contribution to total system LCOE vs clean energy target

**How it works**:
- Sweeps clean targets from 0% to 100% in 5% increments
- Line chart with:
  - Black line: Total System LCOE
  - Red line with shaded fill: Gas contribution to LCOE
- Annotations at 20% and 90% clean targets

**Key insight**: At 95% clean, gas only adds ~$6/MWh to total LCOE despite providing reliability

---

### 16. Leap Chart (`leap.json`)
**Function**: `generate_leap_chart()`

**What it shows**: Weekly dispatch comparison at 70% vs 95% targets

**How it works**:
- Optimizes systems for 70% and 95% targets
- Simulates both and extracts one winter week (hours 720-888)
- Two stacked area charts showing hourly dispatch
- Stack order: Clean Firm (bottom) → Storage → Wind → Solar → Gas (top)

**Key insight**: At 70% gas fills gaps; at 95% clean firm takes over

---

## Part 5: Testing Our Understanding

### 17. Regional Comparison (`regional.json`)
**Function**: `generate_regional_comparison()`

**What it shows**: How optimal mix varies by region at 95% target

**How it works**:
- Runs optimizer for California, Texas, Florida
- Simulates each to get energy breakdown (GWh)
- Stacked bar chart with LCOE annotations

**Key findings**:
- Texas: Strong wind → $84/MWh
- California: Balanced mix → $100/MWh
- Florida: No wind → $107/MWh

---

### 18. Gas Crossover (`gas_crossover.json`)
**Function**: `generate_gas_crossover()`

**What it shows**: At what gas price clean energy beats gas-only

**How it works**:
- Sweeps gas prices: $2-15/MMBtu
- Calculates LCOE for gas-only and clean systems at 70%, 90%, 95%

**Key insight**: At $8+/MMBtu gas, 90% clean becomes cost-competitive

---

### 19. No Clean Firm (`no_cleanfirm.json`)
**Function**: `generate_no_cleanfirm_chart()`

**What it shows**: Cost explosion without clean firm power

**How it works**:
- Compares optimizer runs with/without clean firm enabled

**Key insight**: Without clean firm, 99% target costs 40% more

---

### 20. Clean Firm Technology (`cleanfirm_tech.json`)
**Function**: `generate_cleanfirm_comparison()`

**What it shows**: How different clean firm technologies compare under different financing

**Technologies**:
- Geothermal: $5000/kW capex, $0 fuel
- Nuclear: $8000/kW capex, $10/MWh fuel
- Hydrogen: $1500/kW capex, $60/MWh fuel

---

### 21. Financing Impact (`financing.json`)
**Function**: `generate_financing_impact()`

**What it shows**: Cost of capital vs ITC impact

**Scenarios**:
- Baseline: 7% discount rate, no ITC
- With 30% ITC
- Low cost of capital: 4% discount rate
- Both: 4% + 30% ITC

---

### 22. No Wind (`no_wind.json`)
**Function**: `generate_no_wind_chart()`

**What it shows**: Three scenarios comparing resource availability

**Scenarios**:
- Solar + Storage only
- Solar + Storage + Clean Firm
- Full Mix (all resources)

---

### 23. Greedy vs Optimal (`greedy.json`)
**Function**: `generate_greedy_comparison()`

**What it shows**: Cost penalty of naive "greedy" optimization

**How it works**:
- **Optimal**: Grid search (global optimization)
- **Greedy**: Iteratively adds resource with best $/% improvement

**Key insight**: Greedy works at low targets but costs ~10% more at 99%

---

## Additional Charts (Generated but may not be in main narrative)

### Solar Paradox (`solar_paradox.json`)
Shows solar-only ceiling at ~50% clean energy. Sweeps solar 0-1000 MW with no other resources.

### Gas Capacity (`gas_capacity.json`)
Shows backup gas capacity needed vs clean target.

### Resource Interactions (`resource_interactions.json`)
Shows synergy between solar+storage vs solar+wind.

### Cost Sensitivity (`cost_sensitivity.json`)
LCOE under different cost scenarios (cheap storage, cheap clean firm, expensive gas).

### Marginal Energy (`marginal_energy.json`)
Shows marginal value of additional solar capacity.

### ELCC Storage (`elcc_storage.json`)
Storage-specific capacity credit analysis.

---

## How to Modify Charts

### Change default zone
In each function, change the `zone` parameter:
```python
def generate_lcoe_curve(zone_data, zone='Texas', cost_settings=None):
```

### Change target sweep points
Modify the `targets` or `range()` parameters:
```python
targets = [50, 60, 70, 80, 85, 90, 92, 94, 95, 96, 97, 98, 99]
# or
for target_pct in range(5, 96, 2):  # 5% to 95% in 2% steps
```

### Change cost assumptions
Override `cost_settings`:
```python
cost_settings = {**DEFAULT_COSTS, 'solar': 800, 'storage': 200}
```

### Enable/disable hybrid battery mode
For solar+storage charts:
```python
simulate_system(..., hybrid_mode=True)  # Smoother dispatch
simulate_system(..., hybrid_mode=False)  # Default peak-shaving
```

### Add a new chart
1. Create function in `generate_charts.py`
2. Add to `charts` dict in `main()`
3. Add container ID to `CHARTS` in `js/charts.js`
4. Add `<div id="chart-name" class="chart-container"></div>` to `index.html`

---

## Regenerating Charts

```bash
cd /path/to/Multi-Heatmap\ Test
python microsite/generate_charts.py
```

Takes 5-10 minutes due to grid search optimization runs (especially solar_storage_lcoe and storage_cost_sensitivity).

---

## File Structure

```
microsite/
├── index.html              # Main page with 5 parts + takeaways
├── css/style.css           # Styling (includes .assumptions-dropdown)
├── js/charts.js            # Chart loader (maps 21 container IDs to JSON files)
├── data/                   # Generated chart JSON files (29 total)
│   ├── mismatch.json
│   ├── lcoe_curve.json
│   ├── solar_storage_lcoe.json
│   ├── storage_cost_sensitivity.json
│   └── ... (25 more)
├── generate_charts.py      # Chart generation script (~3500 lines, 29 functions)
├── CHART_DOCUMENTATION.md  # This file
└── README.md               # Quick start guide
```

---

## Key Implementation Notes

1. **Hybrid Mode**: Solar+storage charts use `hybrid_mode=True` for smoother battery dispatch that better reflects real-world operation.

2. **Grid Search Optimization**: The solar_storage_lcoe and storage_cost_sensitivity charts use exhaustive grid search (not gradient-based) to find minimum LCOE at each target.

3. **Hover Disabled**: Several charts have `hoverinfo: 'skip'` for cleaner presentation.

4. **Annotations**: Charts use Plotly annotations for labels, callouts, and storage hour markers.

5. **Color Consistency**: Technologies use consistent colors across charts (Solar: yellow, Wind: blue, Clean Firm: orange, Gas: gray, Storage: purple).
